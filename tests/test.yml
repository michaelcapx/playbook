---
- name: Testing Playbook
  hosts: all

  vars_files:
    - ../vars/config.yml

  vars:
    ran_from_vagrant: false
    test_user: "{{ ansible_env.USER }}"
    test_home: "{{ ansible_env.HOME }}"
    test_cases: []

  pre_tasks:
    - name: Upgrade dist
      apt: update_cache=yes upgrade=dist
      when: ran_from_vagrant == "true"

    - name: Install virtualbox packages when running in Vagrant
      apt:
        name: "{{ item }}"
        update_cache: yes
      when: ran_from_vagrant == "true"
      with_items:
        - virtualbox-guest-dkms
        - virtualbox-guest-x11

  roles:
    # - { role: ../roles/testrole, become: true }

  tasks:
    - name: Display the Ansible version info
      debug:
        var: ansible_version
        verbosity: 4

    - name: Display all variables/facts known for a host
      debug:
        var: hostvars[inventory_hostname]
        verbosity: 4

  post_tasks:
    - name: Run test suite
      command: "{{ item }}"
      changed_when: false
      register: test_results
      with_items: "{{ test_cases }}"
      when: test_cases | length

    - name: Print out test results variable
      debug:
        var: test_results
        verbosity: 2

    - name: Print out test results
      debug:
        msg: "{{ item.stdout }}"
        verbosity: 1
      with_items: "{{ test_results.results }}"
